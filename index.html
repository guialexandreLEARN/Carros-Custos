document.addEventListener('DOMContentLoaded', function() {
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Função para buscar o ID do documento pelo RENAVAM
    function getCarDocumentIdByRenavam(renavam) {
        return db.collection('Caracteristicas')
            .where('RENAVAM', '==', renavam)
            .get()
            .then(querySnapshot => {
                if (!querySnapshot.empty) {
                    return querySnapshot.docs[0].id; // Retorna o ID do primeiro documento encontrado
                } else {
                    throw new Error('Carro não encontrado.');
                }
            });
    }

    // Função de editar carro
    const editCarButton = document.getElementById('editCarButton');
    if (editCarButton) {
        editCarButton.addEventListener('click', function() {
            const renavam = document.getElementById('renavam').value;
            const marca = document.getElementById('marca').value;
            const modelo = document.getElementById('modelo').value;
            const anoFab = document.getElementById('anoFab').value;
            const anoModelo = document.getElementById('anoModelo').value;
            const versao = document.getElementById('versao').value;
            const litragemMotor = document.getElementById('litragemMotor').value;
            const cor = document.getElementById('cor').value;
            const placaAntiga = document.getElementById('placaAntiga').value;
            const placaMercosul = document.getElementById('placaMercosul').value;
            const codigoFIPE = document.getElementById('codigoFIPE').value;

            // Buscar o ID do documento e depois atualizar
            getCarDocumentIdByRenavam(renavam)
                .then(docId => {
                    return db.collection('Caracteristicas').doc(docId).update({
                        Marca: marca,
                        Modelo: modelo,
                        Ano_Fab: anoFab,
                        Ano_Modelo: anoModelo,
                        Versao: versao,
                        Litragem_Motor: litragemMotor,
                        Cor: cor,
                        Placa_Antiga: placaAntiga,
                        Placa_Mercosul: placaMercosul,
                        Codigo_FIPE: codigoFIPE
                    });
                })
                .then(() => {
                    alert('Carro atualizado com sucesso!');
                })
                .catch(error => {
                    console.error('Erro ao editar carro:', error);
                    alert('Erro ao editar carro: ' + error.message);
                });
        });
    }

    // Função de excluir carro
    const deleteCarButton = document.getElementById('deleteCarButton');
    if (deleteCarButton) {
        deleteCarButton.addEventListener('click', function() {
            const renavam = document.getElementById('renavam').value;

            // Buscar o ID do documento e depois excluir
            getCarDocumentIdByRenavam(renavam)
                .then(docId => {
                    return db.collection('Caracteristicas').doc(docId).delete();
                })
                .then(() => {
                    alert('Carro excluído com sucesso!');
                    carForm.reset(); // Limpa o formulário após excluir
                })
                .catch(error => {
                    console.error('Erro ao excluir carro:', error);
                    alert('Erro ao excluir carro: ' + error.message);
                });
        });
    }
});
